var cpicker_data = {
	"AFG": "Afghanistan",
	"ALA": "Åland Islands",
	"ALB": "Albania",
	"DZA": "Algeria",
	"ASM": "American Samoa",
	"AND": "Andorra",
	"AGO": "Angola",
	"AIA": "Anguilla",
	"ATA": "Antarctica",
	"ATG": "Antigua and Barbuda",
	"ARG": "Argentina",
	"ARM": "Armenia",
	"ABW": "Aruba",
	"AUS": "Australia",
	"AUT": "Austria",
	"AZE": "Azerbaijan",
	"BHS": "Bahamas",
	"BHR": "Bahrain",
	"BGD": "Bangladesh",
	"BRB": "Barbados",
	"BLR": "Belarus",
	"BEL": "Belgium",
	"BLZ": "Belize",
	"BEN": "Benin",
	"BMU": "Bermuda",
	"BTN": "Bhutan",
	"BOL": "Bolivia",
	"BES": "Bonaire",
	"BIH": "Bosnia and Herzegovina",
	"BWA": "Botswana",
	"BVT": "Bouvet Island",
	"BRA": "Brazil",
	"IOT": "British Indian Ocean Territory",
	"VGB": "British Virgin Islands",
	"BRN": "Brunei",
	"BGR": "Bulgaria",
	"BFA": "Burkina Faso",
	"BDI": "Burundi",
	"KHM": "Cambodia",
	"CMR": "Cameroon",
	"CAN": "Canada",
	"ICN": "Canary Islands",
	"CPV": "Cape Verde",
	"CRB": "Caribbean",
	"CYM": "Cayman Islands",
	"CAF": "Central African Republic",
	"TCD": "Chad",
	"CHL": "Chile",
	"CHN": "China",
	"CXR": "Christmas Island",
	"CCK": "Cocos Islands",
	"COL": "Colombia",
	"COM": "Comoros",
	"COG": "Congo",
	"COK": "Cook Islands",
	"CRI": "Costa Rica",
	"HRV": "Croatia",
	"CUB": "Cuba",
	"CUW": "Curaçao",
	"CYP": "Cyprus",
	"CZE": "Czechia",
	"DNK": "Denmark",
	"DJI": "Djibouti",
	"DMA": "Dominica",
	"DOM": "Dominican Republic",
	"COD": "DR Congo",
	"TLS": "East Timor",
	"ECU": "Ecuador",
	"SLV": "El Salvador",
	"ENG": "England",
	"EGY": "Egypt",
	"GNQ": "Equatorial Guinea",
	"ERI": "Eritrea",
	"EST": "Estonia",
	"SWZ": "Eswatini",
	"ETH": "Ethiopia",
	"EUR": "Europe",
	"FLK": "Falkland Islands",
	"FRO": "Faroe Islands",
	"FJI": "Fiji",
	"FIN": "Finland",
	"FRA": "France",
	"GUF": "French Guiana",
	"PYF": "French Polynesia",
	"ATF": "French Southern Territories",
	"GAB": "Gabon",
	"GMB": "Gambia",
	"GEO": "Georgia",
	"DEU": "Germany",
	"GHA": "Ghana",
	"GIB": "Gibraltar",
	"GRC": "Greece",
	"GRL": "Greenland",
	"GRD": "Grenada",
	"GLP": "Guadeloupe",
	"GUM": "Guam",
	"GTM": "Guatemala",
	"GGY": "Guernsey",
	"GIN": "Guinea",
	"GNB": "Guinea-Bissau",
	"GUY": "Guyana",
	"HTI": "Haiti",
	"HMD": "Heard Island and McDonald Islands",
	"HND": "Honduras",
	"HKG": "Hong Kong",
	"HUN": "Hungary",
	"ISL": "Iceland",
	"IND": "India",
	"IDN": "Indonesia",
	"IRN": "Iran",
	"IRQ": "Iraq",
	"IRL": "Ireland",
	"IMN": "Isle of Man",
	"ISR": "Israel",
	"ITA": "Italy",
	"CIV": "Ivory Coast",
	"JAM": "Jamaica",
	"JPN": "Japan",
	"JEY": "Jersey",
	"JOR": "Jordan",
	"KAZ": "Kazakhstan",
	"KEN": "Kenya",
	"KIR": "Kiribati",
	"KOS": "Kosovo",
	"KWT": "Kuwait",
	"KGZ": "Kyrgyzstan",
	"LAO": "Laos",
	"LVA": "Latvia",
	"LBN": "Lebanon",
	"LSO": "Lesotho",
	"LBR": "Liberia",
	"LBY": "Libya",
	"LIE": "Liechtenstein",
	"LTU": "Lithuania",
	"LUX": "Luxembourg",
	"MAC": "Macao",
	"MDG": "Madagascar",
	"MWI": "Malawi",
	"MYS": "Malaysia",
	"MDV": "Maldives",
	"MLI": "Mali",
	"MLT": "Malta",
	"MHL": "Marshall Islands",
	"MTQ": "Martinique",
	"MRT": "Mauritania",
	"MUS": "Mauritius",
	"MYT": "Mayotte",
	"MEX": "Mexico",
	"FSM": "Micronesia",
	"MDA": "Moldova",
	"MCO": "Monaco",
	"MNG": "Mongolia",
	"MNE": "Montenegro",
	"MSR": "Montserrat",
	"MAR": "Morocco",
	"MOZ": "Mozambique",
	"MMR": "Myanmar",
	"NAM": "Namibia",
	"NRU": "Nauru",
	"NPL": "Nepal",
	"NLD": "Netherlands",
	"NCL": "New Caledonia",
	"NZL": "New Zealand",
	"NIC": "Nicaragua",
	"NER": "Niger",
	"NGA": "Nigeria",
	"NIU": "Niue",
	"NFK": "Norfolk Island",
	"PRK": "North Korea",
	"MKD": "North Macedonia",
	"NIR": "Northern Ireland",
	"MNP": "Northern Mariana Islands",
	"NOR": "Norway",
	"OMN": "Oman",
	"PAK": "Pakistan",
	"PLW": "Palau",
	"PSE": "Palestine",
	"PAN": "Panama",
	"PNG": "Papua New Guinea",
	"PRY": "Paraguay",
	"PER": "Peru",
	"PHL": "Philippines",
	"PCN": "Pitcairn",
	"POL": "Poland",
	"PRT": "Portugal",
	"PRI": "Puerto Rico",
	"QAT": "Qatar",
	"REU": "Réunion",
	"ROU": "Romania",
	"RUS": "Russia",
	"RWA": "Rwanda",
	"BLM": "Saint Barthélemy",
	"SHN": "Saint Helena",
	"KNA": "Saint Kitts and Nevis",
	"LCA": "Saint Lucia",
	"MAF": "Saint Martin",
	"SPM": "Saint Pierre and Miquelon",
	"VCT": "Saint Vincent and the Grenadines",
	"WSM": "Samoa",
	"SMR": "San Marino",
	"STP": "Sao Tome and Principe",
	"SAU": "Saudi Arabia",
	"SCO": "Scotland",
	"SEN": "Senegal",
	"SRB": "Serbia",
	"SYC": "Seychelles",
	"SLE": "Sierra Leone",
	"SGP": "Singapore",
	"SXM": "Sint Maarten",
	"SVK": "Slovakia",
	"SVN": "Slovenia",
	"SLB": "Solomon Islands",
	"SOM": "Somalia",
	"ZAF": "South Africa",
	"SGS": "South Georgia and the South Sandwich Islands",
	"KOR": "South Korea",
	"SSD": "South Sudan",
	"ESP": "Spain",
	"LKA": "Sri Lanka",
	"SDN": "Sudan",
	"SUR": "Suriname",
	"SWE": "Sweden",
	"SJM": "Svalbard and Jan Mayen",
	"CHE": "Switzerland",
	"SYR": "Syria",
	"TWN": "Taiwan",
	"TJK": "Tajikistan",
	"TZA": "Tanzania",
	"THA": "Thailand",
	"TGO": "Togo",
	"TKL": "Tokelau",
	"TON": "Tonga",
	"TTO": "Trinidad and Tobago",
	"TUN": "Tunisia",
	"TUR": "Turkey",
	"TKM": "Turkmenistan",
	"TCA": "Turks and Caicos Islands",
	"TUV": "Tuvalu",
	"UGA": "Uganda",
	"UKR": "Ukraine",
	"ARE": "United Arab Emirates",
	"GBR": "United Kingdom",
	"UMI": "United States Minor Outlying Islands",
	"USA": "United States of America",
	"VIR": "United States Virgin Islands",
	"URY": "Uruguay",
	"UZB": "Uzbekistan",
	"VUT": "Vanuatu",
	"VAT": "Vatican City",
	"VEN": "Venezuela",
	"VNM": "Viet Nam",
	"WAL": "Wales",
	"WLF": "Wallis and Futuna",
	"ESH": "Western Sahara",
	"YEM": "Yemen",
	"ZMB": "Zambia",
	"ZWE": "Zimbabwe"
};

var cpicker_prop = {
	btnClass: "btn btn-outline-primary mr-1 mb-1",
	btnSelectedClass: "btn btn-primary mr-1 mb-1",
	clearClass: "ml-2 badge badge-secondary p-2",
	clearHtml: "X",
	imgClass: "mr-1",
	imgHeight: "20px",
	imgRoot: "",
	maxResults: 3,
	requiredClassAlert: "badge badge-danger",
	requiredClassArea: "border border-danger",
	requiredClassSearch: "border border-danger",
	requiredMessage: "Please select a country",
	selector: ".country-picker",
	showFlags: true,
	showMoreText: "+{count}"
};

$(document).ready(function(){
	
	$.each($(cpicker_prop.selector),function(k,v){
		var id = $(v).attr("id");

		var selectedCountry = "";
		if ( $(v).val() !== "" ) {
			selectedCountry = $(v).val();
			$(v).val("");
		}
		$("#"+ id).attr("id",id + "-search").attr("name",id+"-search");
		$('label[for="' + id + '"]').attr("for",id+"-search");
		var pickerArea = id + "-pickarea";
		$("#" + pickerArea).append(
			$("<INPUT></INPUT>").attr("type","hidden").attr("name",id).attr("id",id)
		);
		if ( $("#"+id+"-search").prop("required") ) {
			$("#"+id).prop("required",true);
			$("#"+id+"-search").removeAttr("required");
			$("#"+id).closest("form").on("submit",function(){
				$("#" + pickerArea).removeClass(cpicker_prop.requiredClassArea);
				$("#" + id + "-search").removeClass(cpicker_prop.requiredClassSearch);
				$("#" + id + "-pickarea .cpicker-req").remove();
				if ( $("#"+id).val() === "" ) {
					$("#" + pickerArea).addClass(cpicker_prop.requiredClassArea);
					$("#" + id + "-search").addClass(cpicker_prop.requiredClassSearch);
					$("#" + id + "-pickarea").prepend( $("<BR />").addClass("cpicker-req") ).prepend( $("<DIV></DIV>").addClass(cpicker_prop.requiredClassAlert).addClass("cpicker-req").html(cpicker_prop.requiredMessage) );
					return false;
				}
			});
		}
		$(v).keyup(function(){
			var search = $(this).val();
			search.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
			if ( search.length >= 3 ) {
				if ( $(this).data().prev !== search ) {
					cpickerDoSearch(search,pickerArea,false);
				}
			} else {
				cpickerClearSearch(pickerArea);
			}
			$(this).data().prev = search;
		});

		if ( selectedCountry === "" ) {
			cpickerNoResults(pickerArea);
		} else {
			cpickerFindResult(selectedCountry,pickerArea);
		}
	});

});

function cpickerDoSearch(term,area,exact) {
	cpickerClearSearch(area);
	$.each( $("#" + area + " .btn-cpicker-selected .cpicker-v"), function(k,v) {
		$(this).html( cpickerHighlight(term,$(this).html() ) );
	});
	var found = 0;
	var shown = 0;
	$.each(cpicker_data,function(k,v){
		if (
			(
				( !exact && v.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").indexOf(term.toLowerCase()) !== -1 )
				||
				( exact && v === term )
			)
			&& $("button[cpicker_data-k='" + k + "']").length === 0
			) {
			found++;
			if ( shown < cpicker_prop.maxResults || cpicker_prop.maxResults === 0 ) {
				shown++;
				if ( cpicker_prop.showFlags ) {
					$flag = $("<IMG></IMG>").attr("src",cpicker_prop.imgRoot + "img/"+k+".png").addClass(cpicker_prop.imgClass).css("height",cpicker_prop.imgHeight).css("top","-1px").css("position","relative");
				} else {
					$flag = "";
				}
				$("#" + area).append(
					$("<BUTTON></BUTTON>").attr("type","button").addClass(cpicker_prop.btnClass).addClass("btn-cpicker").attr("cpicker_data-k",k)
					.append( $("<SPAN></SPAN>").addClass("cpicker-v").html(cpickerHighlight(term,v)))
					.prepend($flag)
					.on("click",function(){
						if ( $(this).find("span.cpicker_clear").length === 0 ) {
							$(this).find("span.cpicker_clear").remove();
							$("#" + area.replace("-pickarea","")).val(k);
							$("#" + area + " .btn-cpicker").removeClass(cpicker_prop.btnSelectedClass).addClass(cpicker_prop.btnClass).removeClass("btn-cpicker-selected");
							$(this).removeClass(cpicker_prop.btnClass).addClass(cpicker_prop.btnSelectedClass).addClass("btn-cpicker-selected");
							$(this).append(
								$("<SPAN></SPAN>").html(cpicker_prop.clearHtml).addClass(cpicker_prop.clearClass).addClass("cpicker_clear")
							)
						} else {
							$(this).find("span.cpicker_clear").remove();
							$(this).removeClass(cpicker_prop.btnSelectedClass).addClass(cpicker_prop.btnClass).removeClass("btn-cpicker-selected");
							$("#" + area.replace("-pickarea","")).val("");
						}
					})
				)
			}
		}
	});
	if ( found === 0 ) {
		cpickerNoResults(area);
	} else if ( found !== shown ) {
		cpickerMoreResults(area,shown-found);
	}
}

function cpickerClearSearch(area) {
	$("#" + area + " .btn-cpicker:not(.btn-cpicker-selected)").remove();
	$("#" + area + " .cpicker_showmore").remove();
	$.each( 	$("#" + area + " .btn-cpicker-selected strong"), function(k,v) {
		$(this).replaceWith($(this).html());
	});
}

function cpickerNoResults(area) {
	console.log("no results for " + area);
}

function cpickerMoreResults(area,notShownCount) {
	$("#" + area).append(
		$("<SPAN></SPAN>").addClass(cpicker_prop.showMoreClass).addClass("cpicker_showmore").html(cpicker_prop.showMoreText.replace("{count}",Math.abs(notShownCount)))
	);
}

function cpickerFindResult(code,area) {
	cpickerDoSearch(cpicker_data[code],area,true);
	$("#" + area).find("[cpicker_data-k='"+code+"']").click();
}

function cpickerProperties(obj) {
	$.each(obj,function(k,v){
		if ( cpicker_prop[k] !== null) {
			cpicker_prop[k] = v;
		}
	});
}

function cpickerHighlight(search,value) {
	var regEx = new RegExp(search,"gi");
	var newVal = value.replace(regEx, "<strong>$&</strong>");

	// special cases: Åland Islands
	regEx = new RegExp(search.replace("a","å"),"gi");
	newVal = newVal.replace(regEx, "<strong>$&</strong>").replace("<strong><strong>","<strong>").replace("</strong></strong>","</strong>");

	// special cases: Curaçao
	regEx = new RegExp(search.replace("c","ç"),"gi");
	newVal = newVal.replace(regEx, "<strong>$&</strong>").replace("<strong><strong>","<strong>").replace("</strong></strong>","</strong>");

	// special cases: Réunion / Saint Barthélemy
	regEx = new RegExp(search.replace("e","é"),"gi");
	newVal = newVal.replace(regEx, "<strong>$&</strong>").replace("<strong><strong>","<strong>").replace("</strong></strong>","</strong>");

	return newVal;
}